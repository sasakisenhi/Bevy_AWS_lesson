# Architecture

本ドキュメントは、このリポジトリにおける  
**変更してはならない構造（アーキテクチャ）**を定義する。

実装詳細や試行錯誤は `design.md` に記載し、  
ここでは **全体構造・責務・依存方向**のみを扱う。

---

## 全体構成（文章による構成図）

本プロジェクトは、以下の三層構造を持つ。

- **game_core**
- **game_logic**
- **game_runtime**

依存関係は一方向であり、次の順序のみを許可する。

game_runtime
↓
game_logic
↓
game_core

逆方向の依存、および同一レイヤー間の循環依存は禁止する。

---

## 各レイヤーの責務

### game_core

#### 役割
- ゲームの**本質的な概念・ルール・データ構造**を定義する
- 外部環境（Bevy・I/O・時間・描画）に依存しない純粋な領域

#### してよいこと
- 純粋なデータ構造・型の定義
- ドメインルールの表現
- 状態遷移ロジック（副作用を伴わないもの）
- 単体テストによる検証

#### してはいけないこと
- Bevy への依存
- ECS（Component / System / Resource）の使用
- 時間・入力・描画・乱数など外部要因への依存
- グローバル状態の保持

---

### game_logic

#### 役割
- **ゲームルールを実際に動かす層**
- game_core の概念を組み合わせ、ゲームとして意味のある振る舞いを構成する

#### してよいこと
- game_core の型・ルールを利用したロジック構築
- ECS の System に相当する処理の定義
- 状態遷移・判定・制御フローの記述
- テスト可能な形でのロジック分離

#### してはいけないこと
- 描画・ウィンドウ・入力デバイスへの直接依存
- Bevy の Plugin / App への直接的な組み込み
- game_runtime 固有の概念への依存

---

### game_runtime

#### 役割
- **実行環境との接続点**
- Bevy を用いてゲームを「動かす」ための層

#### してよいこと
- Bevy Plugin / App / System の定義
- 入力・描画・時間・リソース管理
- game_logic を呼び出すための接着コード
- 統合的・探索的な動作確認

#### してはいけないこと
- ゲームルールの本質的判断を直接書くこと
- game_core のデータ構造を破壊的に操作すること
- ロジックの重複実装

---

## 依存方向の理由

### なぜ runtime → logic → core なのか

この依存方向は、**変更頻度の差**に基づいている。

- game_runtime  
  → 最も変更されやすい（入力・UI・描画・実行環境）
- game_logic  
  → 中程度に変更される（ルール調整・仕様変更）
- game_core  
  → 最も安定している（概念・前提・ルール）

変更されやすい層が、  
変更されにくい層に依存することで、

- 下位層が安定する
- テストしやすくなる
- 設計の破壊が局所化される

という効果が得られる。

---

## 変更してよい／いけない境界

### 設計変更として扱うもの

以下は **設計変更** とみなし、  
実装を伴わず、まず提案・議論の対象とする。

- 各レイヤーの責務の再定義
- 公開 API（pub）の意味的変更
- レイヤー間の依存方向・依存関係の追加
- game_core のデータモデルの根本的変更

### 設計変更として扱わないもの

以下は **実装変更** として扱う。

- 内部実装の改善・リファクタリング
- テストの追加・修正
- パフォーマンス改善（意味を変えない範囲）
- game_runtime における表現・接着コードの調整

---

## 本ドキュメントの位置づけ

- 本ドキュメントは **「壊してはいけない構造」** を定義する
- 試行錯誤・判断理由・代替案は `design.md` に記載する
- 本ドキュメントと矛盾する変更は、意図的な設計変更として扱う

---

## 最後に

このアーキテクチャは、  
**柔軟性を捨てるためのものではなく、  
試行錯誤を安全に行うための土台**である。

構造が守られている限り、  
実装は自由であり、失敗は歓迎される。

※ 将来、レイヤーの分割や追加が必要になった場合は、
本ドキュメントを更新したうえで設計変更として扱う。
