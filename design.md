# Design

本ドキュメントは、このリポジトリにおける設計上の判断・試行錯誤・代替案・仮説を記録する。  
`architecture.md` が「壊してはいけない構造」を定義するのに対し、ここでは **変わりうる設計**を扱う。

- 未確定な部分は「仮」と明示して進めてよい
- 迷い・代替案・却下した案も価値として残す
- 決定事項が安定してきたら `architecture.md` や README へ昇格させる

---

## 目的と作りたいゲームの方向性（暫定）

- 目的: 学習・検証を通じて、ゲーム開発の設計力と開発者体験（DX）を高める
- 題材: 2D 物理シミュレーション系（例: “物理現象を遊べる”ゲーム）
- 重要視する点:
  - 「現象の面白さ」を追加しやすい拡張性
  - テスト可能なロジック設計（core / logic を中心に）
  - 実装の失敗を歓迎し、試行錯誤のコストを下げる

---

## 設計の優先順位（再掲・運用ルール）

- 正しさ > 速さ > 短さ
- レイヤー境界を破らない（runtime → logic → core）
- 変更は段階的に行い、差分を小さく保つ
- コメントは「なぜ」を書く（「何を」は名前で表す）
- 公開 API には rustdoc と `# Examples` を原則付ける

---

## 主要コンセプト（仮）

### エンティティの考え方
- （仮）ゲーム内の「粒子」「流体」「壁」「熱源」などを、概念として `game_core` に置く
- それらをどう更新するか（ルール）は `game_logic` に置く
- 実際に Bevy ECS の Entity/Component に落とすのは `game_runtime` の責務とする

### 状態更新の単位
- （仮）FixedUpdate（固定ステップ）で物理・シミュレーションを進める
- Update では入力・UI・描画の調整を行う
- ただし、最初期は複雑化を避け、段階的に固定ステップへ寄せる

---

## データモデル（仮）

### core に置くもの
- 位置・速度などの基本データ型（例: Vec2）
- 物質の種類やパラメータ（例: 密度、温度、摩擦）
- ルールに必要なドメイン型（例: MaterialId、CellIndex など）

### logic に置くもの
- 更新ルール（例: 拡散、衝突、落下、燃焼など）
- ルール適用順序（例: 優先度、フェーズ）
- ルール適用のための中間表現（必要になったら）

---

## ロジック構成案（仮）

### ルール駆動（Rule-based）
- 例: `apply_gravity` / `resolve_collisions` / `diffuse_heat` など
- 利点:
  - 追加しやすい
  - テストしやすい
- 欠点:
  - ルールの相互作用が増えると順序依存が出る

（仮）最初はこの方式で進め、複雑化したらルールのフェーズ分割を検討する。

---

## ECS への落とし込み方針（runtime 側・仮）

- runtime は Bevy の Component / System / Resource を持つ
- logic は「ECS に依存しない関数」として呼び出せる形を目指す
- 具体的には、runtime が ECS 状態を抽出し、logic に入力し、結果を ECS に反映する
  - 抽出・反映の責務は runtime

---

## テスト方針（運用・暫定）

### game_core
- 型・ルールの単体テストを中心
- rustdoc の `# Examples` を仕様固定点として活用する

### game_logic
- ルール単位のテスト
- 可能なら「入力 → 出力」が明確な純粋関数に寄せる
- 乱数・時間に依存するものは注入（DI）やシード固定で扱う

### game_runtime
- 統合的な動作確認を中心
- UI/入力/描画は自動テストより手動検証を許容する
- 自動化する場合は段階的に（スクショ比較等は後回し）

---

## 代替案・却下案（メモ）

### 案: 最初から runtime を細分化する
- 却下理由:
  - 早期最適化になりやすい
  - 変更の速度が落ちる
- 保留:
  - コードが散らかってから整理する（散らかった事実を根拠に分割する）

### 案: すべてを ECS で完結させる
- 却下理由:
  - core / logic のテスト容易性が落ちる
  - 概念が Bevy に吸われる
- ただし:
  - runtime の接着層は増えるため、必要最小限で設計する

---

## 直近の意思決定ログ（ここに追記していく）

- 例）YYYY-MM-DD: （決めたこと） / （理由） / （代替案）
- 例）YYYY-MM-DD: （困っていること） / （仮対応）

---

## TODO（設計としての次の問い）

- 物理シミュレーションの最初の最小単位は何か？（粒子 / セル / 連続体）
- シミュレーションの更新順序をどう固定するか？
- runtime ↔ logic のデータ受け渡しの最小形は何か？
- ゲームとしての「勝ち・目標・気持ちよさ」をどこで定義するか？
